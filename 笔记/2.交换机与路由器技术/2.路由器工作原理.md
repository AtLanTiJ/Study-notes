# 路由器的工作原理

## 一、回顾交换机工作原理

- 交换机里维护了一张MAC地址表，主要记录的是MAC地址和接口的对应关系
- 交换机在初始状态下，MAC地址表是空的，当收到一个来自某接口（f0/1)的数据时，首先查看数据帧中的源MAC地址，对照自己记得MAC地址表，如果不在表中，将发送发的MAC地质学系并记录到自己的MAC地址表中，并附上对应的接口（f0/1），再查看目的MAC地址，如果目的MAC地址也不在MAC地址表中，将进行从接口（f0/1）外的其他连接的接口转发出去（广播方式），此时，目的主机和其他主机都会接收到，其他主机接收到后直接丢弃，目的主机接收到后进行回应，回应过程中数据同样会交给交换机转发，这时目的主机就变成回应的发送主机，当交换机接收到来自目的主机的回应报文时（f0/10），同样查看发送方的MAC地址，进行学习并记录，并附带对应接口（f0/10），再去看目的MAC，由于之前已有记录，所以直接从记录的接口（f0/1）进行转发（单播）
- 总结：交换机学习源MAC，广播数据帧，接收方回应，回应使用单播直接发送

## 二、回顾路由器相关知识

- 路由器是网络层设备
- 网络层所封装的是IP头部
- 网络层功能
  - 进行逻辑地址（IP地址）寻址，实现不同网络（网络地址不等或者内网和外网分割，**强调：内网IP地址是无法在外网上进行路由的）**之间的路径选择
  - 去查找目的是否可达，如果可达，选择一条最优路径，如果不能达，直接返回发送方一个消息
- 网络层所能传输的PDU（传输数据单元）是数据包

## 三、网络层IP数据包的格式

- IPv4

  ![img](https://img-blog.csdnimg.cn/20190507143942341.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDUzMjg1,size_16,color_FFFFFF,t_70)

  - 版本：标识当前使用的IP版本

  - 首部长度：由于IP数据报文的首部有一个可选项，所以首部长度是可变的，所以需要定义首部长度

  - 区分服务（服务质量）：为了保障更好的服务，主要在IP层做QOS
  - 总长度：主要用来标识整个数据包的长度
  - 标识、标志、片偏移：上层来的数据到IP层会被分片，这几个字段用来对数据包进行标识，使数据到达目的端重组的时候不会乱序
  - 生存时间（TTL值）：数据包在路由器的消耗时间如果小于1秒，TTL就会减一，减完丢掉
  - 协议：标识上层数据是使用的何种协议（TCP是6，UDP是17）
  - 首部校验：校验数据报文的首部
  - 源地址：发送方IP地址
  - 目的地址：接收方IP地址

- IPv6

## 四、路由器工作原理

### 1. 路由

- 从源主机到目标主机的转发过程
- 包含两个内容：
  - 确定最佳路径（手动指定、动态路由协商方式）
  - 通过网络传输信息

### 2. 路由器工作原理

![image-20220604132514151](https://s2.loli.net/2022/07/22/In2rTyHzSguNlPQ.png)

- 路由表
  - 直连路由：当路由器的接口配置好对应的IP地址并开启接口后自动生成
  - 非直连路由：需要手动配置静态路由或者使用动态路由协议学习
- 静态路由
  - 由管理员手动配置，不灵活，而且是单向
  - 特殊的静态路由：默认路由，当在路由器的路由表中找不到目标网络条目是，再去查看默认路由
    - 使用场景：一般应用于末节网络（网络的最末端/路由器只连接了一个网络）
- 动态路由
  - 通过某种动态路由西医自动地去建立自己路由表
  - 常见动态路由协议：RIP   OSPF    IS-IS   BGP    IGRP      EIGRP

## 五、路由器转发数据包的封装过程

![](https://s2.loli.net/2022/07/22/rYAw7UQ2sS1moNC.png)



