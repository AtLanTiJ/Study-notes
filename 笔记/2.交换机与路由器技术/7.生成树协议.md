# 生成树协议（STP）

## 一、STP概念

- 防止交换机冗余链路产生环路，避免广播风暴

## 二、STP工作原理

- 选择根网桥（交换机）
  - 比较**网桥ID**（网桥的优先级+网桥的MAC地址。网桥优先级默认是32768，可以由管理员更改，需要更改为4096的倍数），网桥ID较小的为根交换机
  - 根网桥上的端口不可能被阻塞
- 选择根端口
  - 根路径成本最少
  - 直连网桥ID最小
  - 端口ID最小（端口ID默认是128）
- 选择指定端口
  - 根网桥上的所有端口全是指定端口
  - 每个网段上选择一个指定端口
  - 非根网桥上选指定端口
    - 根路径成本最少
    - 网桥ID最小
    - 端口ID最小（端口ID默认是128）
- 没有被选中的端口就是阻塞端口

## 三、STP其他概念

### 3.1 STP的收敛

- 收敛：整个网络达到一致的情况
- 交换机的端口的五种状态
  - 禁用：down
  - 阻塞：不能发送数据，也不会进行mac地址学习，只会侦听网络的BPDU（拓扑变更通告）
  - 侦听：可以收发BPDU，但不会进行MAC地址学习
  - 学习：可以收发BPDU并可以进行MAC地址学习，不会转发数据
  - 转发：正常转发业务数据
- 计时器
  - hello时间
  - 转发延时
  - 最大老化时间

## 四、配置

- 因为交换机上有vlan的划分，当划分了广播域，就阻挡了广播，所以不同vlan具有不同STP

### 1. 单生成树（交换机上只有一个valn）

- 设置网桥优先级

  ```
  sw2(config)#spanning-tree vlan 1 priority 4096
  ```

- 指定sw3的f0/3接口为阻塞

  - 设置sw1的网桥优先级为8192

    ```
    sw1(config)#spanning-tree vlan 1 priority 8192
    ```

![image-20220618101703319](..\..\picture\0ba579c46e50460184cfd8d774235e31.png)

### 2. 多生成树（交换机上有多个valn）

![image-20220618103431973](..\..\picture\09955fb9cd4d45bc81d597efdcaacb81.png)

### 3. 其他配置*

- 直接指定根网桥

  ```
  sw(config)#spanning-tree valn 1 root primary
  ```

- 修改端口成本（端口成本由带宽决定）

  ```
  sw(config-if)#spanning-tree vlan 1 cost 19
  ```

- 修改端口优先级

  ```
  sw(config-if)#spanning-tree vlan 1port-priority 64
  ```

  